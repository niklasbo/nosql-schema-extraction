package de.fernunihagen;

import static org.junit.Assert.assertEquals;
import java.util.Map;

import org.junit.jupiter.api.Test;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.JsonMappingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.dataformat.xml.XmlMapper;

public class UtilsTest {

    @Test
    void testParseCouchDBConnectionString() {
        var p = Utils.parseCouchDBConnectionString("couchdb://mycooldomain:7667/mydatabase", "myuser",
                "mypassword");
        assertEquals("mycooldomain", p.getHost());
        assertEquals("mydatabase", p.getDbName());
        assertEquals("myuser", p.getUsername());
        assertEquals("mypassword", p.getPassword());
        assertEquals(7667, p.getPort());

        p = Utils.parseCouchDBConnectionString("couchdb://mydomainbutportismissing/mydatabase", "myuser",
                "mypassword");
        assertEquals("mydomainbutportismissing", p.getHost());
        assertEquals("mydatabase", p.getDbName());
        assertEquals("myuser", p.getUsername());
        assertEquals("mypassword", p.getPassword());
        assertEquals(5984, p.getPort());
    }

    @Test
    void testXmlSchemaToJsonSchema() throws JsonMappingException, JsonProcessingException {
        final XmlMapper xmlMapper = new XmlMapper();
        final var mapper = new ObjectMapper();

        Map<String, Object> xmlTestData = xmlMapper.readValue(XML_SCHEMA_FULL_FOR_TESTS, Map.class);
        var resultInJsonSchema = Utils.xmlSchemaToJsonSchema(xmlTestData);
        assertEquals(7, resultInJsonSchema.size());
        System.out.println(mapper.writeValueAsString(resultInJsonSchema));

        xmlTestData = xmlMapper.readValue(XML_SCHEMA_VARIATIONS_FOR_TESTS, Map.class);
        resultInJsonSchema = Utils.xmlSchemaToJsonSchema(xmlTestData);
        assertEquals(1, resultInJsonSchema.size());
        System.out.println(mapper.writeValueAsString(resultInJsonSchema));

        xmlTestData = xmlMapper.readValue(XML_SCHEMA_SIMPLE_FOR_TESTS, Map.class);
        resultInJsonSchema = Utils.xmlSchemaToJsonSchema(xmlTestData);
        assertEquals(1, resultInJsonSchema.size());
        System.out.println(mapper.writeValueAsString(resultInJsonSchema));
    }

    private static final String XML_SCHEMA_SIMPLE_FOR_TESTS = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<NoSQLSchema:NoSQLSchema xmi:version=\"2.0\" xmlns:xmi=\"http://www.omg.org/XMI\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:NoSQLSchema=\"http://www.modelum.es/NoSQLSchema\" xsi:schemaLocation=\"http://www.modelum.es/NoSQLSchema platform:/resource/es.um.nosql.s13e/model/nosqlschema.ecore\" name=\"job_1680022127_mongodblocalhost27017mflix\">\n  <entities name=\"Geo\">\n    <variations variationId=\"1\">\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"coordinates\">\n        <type xsi:type=\"NoSQLSchema:PList\">\n          <elementType xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"Number\"/>\n        </type>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"type\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n    </variations>\n  </entities>\n</NoSQLSchema:NoSQLSchema>\n";

    private static final String XML_SCHEMA_VARIATIONS_FOR_TESTS = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<NoSQLSchema:NoSQLSchema xmi:version=\"2.0\" xmlns:xmi=\"http://www.omg.org/XMI\"\n  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n  xmlns:NoSQLSchema=\"http://www.modelum.es/NoSQLSchema\"\n  xsi:schemaLocation=\"http://www.modelum.es/NoSQLSchema platform:/resource/es.um.nosql.s13e/model/nosqlschema.ecore\"\n  name=\"job_1680022127_mongodblocalhost27017mflix\">\n  <entities name=\"Geo\">\n    <variations variationId=\"1\">\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"coordinates\">\n        <type xsi:type=\"NoSQLSchema:PList\">\n          <elementType xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"Number\" />\n        </type>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"type\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\" />\n      </properties>\n    </variations>\n    <variations variationId=\"2\">\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"coordinates\">\n        <type xsi:type=\"NoSQLSchema:PList\">\n          <elementType xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"Number\" />\n        </type>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"type\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"Number\" />\n      </properties>\n    </variations>\n  </entities>\n</NoSQLSchema:NoSQLSchema>";

    private static final String XML_SCHEMA_FULL_FOR_TESTS = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<NoSQLSchema:NoSQLSchema xmi:version=\"2.0\" xmlns:xmi=\"http://www.omg.org/XMI\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:NoSQLSchema=\"http://www.modelum.es/NoSQLSchema\" xsi:schemaLocation=\"http://www.modelum.es/NoSQLSchema platform:/resource/es.um.nosql.s13e/model/nosqlschema.ecore\" name=\"job_1680022127_mongodblocalhost27017mflix\">\n  <entities name=\"Geo\">\n    <variations variationId=\"1\">\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"coordinates\">\n        <type xsi:type=\"NoSQLSchema:PList\">\n          <elementType xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"Number\"/>\n        </type>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"type\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n    </variations>\n  </entities>\n  <entities name=\"Theaters\" root=\"true\">\n    <variations variationId=\"1\" count=\"189\">\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"_id\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"ObjectId\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Aggregate\" name=\"location\" lowerBound=\"1\" upperBound=\"1\" aggregates=\"//@entities.7/@variations.0\"/>\n      <properties xsi:type=\"NoSQLSchema:Reference\" name=\"theaterId\" lowerBound=\"1\" upperBound=\"1\" refsTo=\"//@entities.1\" originalType=\"Number\"/>\n    </variations>\n    <variations variationId=\"2\" count=\"367\">\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"_id\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"ObjectId\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Aggregate\" name=\"location\" lowerBound=\"1\" upperBound=\"1\" aggregates=\"//@entities.7/@variations.1\"/>\n      <properties xsi:type=\"NoSQLSchema:Reference\" name=\"theaterId\" lowerBound=\"1\" upperBound=\"1\" refsTo=\"//@entities.1\" originalType=\"Number\"/>\n    </variations>\n    <variations variationId=\"3\" count=\"1008\">\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"_id\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"ObjectId\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Aggregate\" name=\"location\" lowerBound=\"1\" upperBound=\"1\" aggregates=\"//@entities.7/@variations.2\"/>\n      <properties xsi:type=\"NoSQLSchema:Reference\" name=\"theaterId\" lowerBound=\"1\" upperBound=\"1\" refsTo=\"//@entities.1\" originalType=\"Number\"/>\n    </variations>\n  </entities>\n  <entities name=\"Address\">\n    <variations variationId=\"1\">\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"city\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"state\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"street1\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"zipcode\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n    </variations>\n    <variations variationId=\"2\">\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"city\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"state\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"street1\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"street2\" optional=\"true\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"Null\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"zipcode\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n    </variations>\n    <variations variationId=\"3\">\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"city\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"state\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"street1\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"street2\" optional=\"true\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"zipcode\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n    </variations>\n  </entities>\n  <entities name=\"Comments\" root=\"true\">\n    <variations variationId=\"1\" count=\"9\">\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"_id\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"ObjectId\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"date\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"email\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"movie_id\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"ObjectId\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"name\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"text\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n    </variations>\n  </entities>\n  <entities name=\"Sessions\" root=\"true\">\n    <variations variationId=\"1\" count=\"1\">\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"_id\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"ObjectId\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"jwt\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Reference\" name=\"user_id\" lowerBound=\"1\" upperBound=\"1\" refsTo=\"//@entities.5\" originalType=\"String\"/>\n    </variations>\n  </entities>\n  <entities name=\"Users\" root=\"true\">\n    <variations variationId=\"1\" count=\"184\">\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"_id\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"ObjectId\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"email\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"name\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"password\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n    </variations>\n    <variations variationId=\"2\" count=\"1\">\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"_id\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"ObjectId\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"email\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"name\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Attribute\" name=\"password\">\n        <type xsi:type=\"NoSQLSchema:PrimitiveType\" name=\"String\"/>\n      </properties>\n      <properties xsi:type=\"NoSQLSchema:Aggregate\" name=\"preferences\" optional=\"true\" lowerBound=\"1\" upperBound=\"1\" aggregates=\"//@entities.6/@variations.0\"/>\n    </variations>\n  </entities>\n  <entities name=\"Preferences\">\n    <variations variationId=\"1\" count=\"1\"/>\n  </entities>\n  <entities name=\"Location\">\n    <variations variationId=\"1\" count=\"189\">\n      <properties xsi:type=\"NoSQLSchema:Aggregate\" name=\"address\" lowerBound=\"1\" upperBound=\"1\" aggregates=\"//@entities.2/@variations.1\"/>\n      <properties xsi:type=\"NoSQLSchema:Aggregate\" name=\"geo\" lowerBound=\"1\" upperBound=\"1\" aggregates=\"//@entities.0/@variations.0\"/>\n    </variations>\n    <variations variationId=\"2\" count=\"367\">\n      <properties xsi:type=\"NoSQLSchema:Aggregate\" name=\"address\" lowerBound=\"1\" upperBound=\"1\" aggregates=\"//@entities.2/@variations.2\"/>\n      <properties xsi:type=\"NoSQLSchema:Aggregate\" name=\"geo\" lowerBound=\"1\" upperBound=\"1\" aggregates=\"//@entities.0/@variations.0\"/>\n    </variations>\n    <variations variationId=\"3\" count=\"1008\">\n      <properties xsi:type=\"NoSQLSchema:Aggregate\" name=\"address\" lowerBound=\"1\" upperBound=\"1\" aggregates=\"//@entities.2/@variations.0\"/>\n      <properties xsi:type=\"NoSQLSchema:Aggregate\" name=\"geo\" lowerBound=\"1\" upperBound=\"1\" aggregates=\"//@entities.0/@variations.0\"/>\n    </variations>\n  </entities>\n</NoSQLSchema:NoSQLSchema>\n";

}
